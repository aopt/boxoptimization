$ontext

   Select Boxes

   Shortest path in layered network

$offtext

sets
 iext 'orig nodes + sink' /i1*i384,sink/
 i(iext) 'orig nodes w/o sink' /i1*i384/
 Lext 'orig layers + sink' /layer1*layer4,Lsink/
 L(Lext) 'lyaers w/o sink' /layer1*layer4/
;

table data(i,*)
           size      count
i1          156        1
i2          162        1
i3          168        1
i4          178        2
i5          180        1
i6          185        2
i7          190        1
i8          192        1
i9          193        1
i10         194        1
i11         195        2
i12         197        2
i13         198        2
i14         199        1
i15         200        1
i16         202        1
i17         206        2
i18         210        3
i19         212        2
i20         214        1
i21         215        1
i22         217        5
i23         218        1
i24         220        10
i25         222        1
i26         223        2
i27         224        1
i28         225        7
i29         226        3
i30         227        1
i31         228        4
i32         230        13
i33         232        3
i34         233        2
i35         234        2
i36         235        4
i37         238        4
i38         240        9
i39         241        1
i40         242        4
i41         243        1
i42         244        3
i43         245        1
i44         246        1
i45         247        3
i46         249        1
i47         250        5
i48         251        1
i49         252        4
i50         253        1
i51         254        3
i52         255        5
i53         256        2
i54         257        3
i55         258        5
i56         259        1
i57         260        9
i58         262        7
i59         264        3
i60         265        5
i61         266        1
i62         267        4
i63         268        6
i64         269        1
i65         270        10
i66         271        1
i67         272        5
i68         273        4
i69         274        5
i70         275        6
i71         277        3
i72         278        6
i73         280        4
i74         281        1
i75         282        2
i76         284        1
i77         285        6
i78         287        3
i79         288        5
i80         289        1
i81         290        11
i82         292        2
i83         293        2
i84         294        3
i85         295        8
i86         296        2
i87         297        2
i88         298        4
i89         300        14
i90         302        2
i91         303        4
i92         304        1
i93         305        5
i94         306        2
i95         307        1
i96         308        3
i97         310        7
i98         312        4
i99         313        1
i100        315        9
i101        317        4
i102        318        4
i103        320        13
i104        322        1
i105        323        2
i106        325        4
i107        326        2
i108        327        2
i109        328        2
i110        330        7
i111        332        1
i112        333        2
i113        334        4
i114        335        5
i115        336        3
i116        338        2
i117        339        2
i118        340        7
i119        342        4
i120        343        1
i121        345        7
i122        346        3
i123        347        2
i124        348        3
i125        349        1
i126        350        18
i127        352        2
i128        353        4
i129        354        3
i130        356        1
i131        357        4
i132        358        2
i133        360        12
i134        361        1
i135        362        3
i136        363        2
i137        364        4
i138        365        7
i139        367        3
i140        368        1
i141        370        9
i142        372        3
i143        373        1
i144        375        6
i145        377        3
i146        378        1
i147        380        12
i148        381        1
i149        382        1
i150        383        4
i151        384        4
i152        385        3
i153        386        4
i154        387        4
i155        388        5
i156        389        1
i157        390        1
i158        392        2
i159        393        1
i160        394        2
i161        395        1
i162        396        1
i163        397        2
i164        398        3
i165        400        8
i166        405        2
i167        408        1
i168        410        6
i169        412        5
i170        413        1
i171        415        2
i172        416        2
i173        417        2
i174        418        2
i175        419        3
i176        420        8
i177        423        4
i178        424        2
i179        425        3
i180        428        2
i181        430        12
i182        431        1
i183        432        4
i184        433        5
i185        434        2
i186        435        4
i187        437        1
i188        438        4
i189        440        7
i190        441        1
i191        442        1
i192        443        1
i193        444        2
i194        445        8
i195        446        1
i196        447        1
i197        448        2
i198        450        9
i199        452        1
i200        453        2
i201        455        4
i202        456        1
i203        457        1
i204        458        4
i205        459        1
i206        460        7
i207        462        2
i208        463        1
i209        464        1
i210        465        7
i211        466        2
i212        467        5
i213        468        3
i214        469        2
i215        470        9
i216        472        3
i217        474        1
i218        475        2
i219        476        1
i220        478        4
i221        480        12
i222        482        7
i223        485        4
i224        488        4
i225        490        8
i226        491        2
i227        492        7
i228        493        2
i229        495        3
i230        496        1
i231        497        1
i232        498        7
i233        499        1
i234        500        6
i235        502        3
i236        505        5
i237        506        1
i238        507        2
i239        510        12
i240        512        2
i241        513        1
i242        514        1
i243        515        2
i244        517        2
i245        518        1
i246        520        6
i247        522        1
i248        523        3
i249        524        1
i250        525        6
i251        528        7
i252        530        6
i253        531        1
i254        532        1
i255        534        1
i256        535        5
i257        536        1
i258        538        3
i259        539        1
i260        540        11
i261        541        1
i262        543        3
i263        544        2
i264        545        3
i265        546        3
i266        547        2
i267        548        2
i268        550        13
i269        552        2
i270        555        7
i271        557        4
i272        560        5
i273        562        2
i274        563        2
i275        564        1
i276        565        6
i277        567        2
i278        568        2
i279        569        3
i280        570        3
i281        571        1
i282        572        2
i283        573        1
i284        574        3
i285        576        2
i286        578        1
i287        580        3
i288        584        1
i289        585        2
i290        587        1
i291        588        1
i292        590        1
i293        592        1
i294        593        1
i295        596        1
i296        597        1
i297        600        4
i298        602        5
i299        603        1
i300        604        1
i301        605        7
i302        607        3
i303        608        1
i304        610        6
i305        612        4
i306        615        4
i307        618        2
i308        620        1
i309        622        1
i310        624        1
i311        625        3
i312        627        2
i313        628        3
i314        630        2
i315        632        1
i316        633        1
i317        635        2
i318        637        1
i319        638        2
i320        640        5
i321        642        1
i322        643        1
i323        647        1
i324        648        1
i325        649        1
i326        650        2
i327        655        3
i328        656        1
i329        660        5
i330        662        2
i331        663        1
i332        664        4
i333        665        3
i334        670        2
i335        672        1
i336        677        2
i337        679        1
i338        680        5
i339        685        2
i340        687        1
i341        688        1
i342        690        2
i343        692        1
i344        694        1
i345        695        1
i346        697        1
i347        698        1
i348        700        2
i349        701        1
i350        704        2
i351        705        9
i352        710        2
i353        712        1
i354        715        1
i355        717        1
i356        720        2
i357        722        1
i358        723        1
i359        727        1
i360        730        1
i361        733        2
i362        734        3
i363        735        3
i364        738        1
i365        740        1
i366        743        1
i367        744        1
i368        754        1
i369        755        5
i370        758        1
i371        760        1
i372        766        2
i373        780        7
i374        782        1
i375        783        1
i376        785        1
i377        795        1
i378        805        1
i379        806        1
i380        820        1
i381        823        1
i382        827        2
i383        855        2
i384        864        1
;

parameter count(i), size(i);
count(i) = data(i,'count');
size(i) = data(i,'size');

scalar T 'number of different box sizes';
T = card(L);

alias(iext,jext);
alias(i,j,k);
alias(Lext,L1ext,L2ext);
alias(L,L1,L2);

sets
  ij(i,j)      'allowed i,j combinations: i<=j'
  ijk(i,j,k)   'allowed i,j,k combinations: i<=k<=j'
;
singleton sets
  lastj(j)     'last element of j'
  lastL(L)     'last element of L'
;
ij(i,j) = ord(i)<=ord(j);
ijk(ij(i,j),k) = ord(k)>=ord(i) and ord(k)<=ord(j);
lastj(j) = ord(j)=card(j);
lastL(L) = ord(L)=card(L);

*
* network topology
*
set a(iext,L1ext,jext,L2ext) 'arcs';
a(i,L1,j,L1+1) = ord(j)>ord(i);
a(i,lastL,'sink','Lsink') = yes;

parameter c(iext,L1ext,jext,L2ext) 'cost coefficients';
c(a(i,L1,j,L2)) = sqr(size(j-1)) * sum(ijk(i,j-1,k),count(k));
c(i,lastL,'sink','Lsink') = sqr(size(lastj)) * sum(ijk(i,lastj,k),count(k));

parameter pinflow(iext,Lext)  'source/sink' /
   sink.Lsink   -1
   i1.layer1     1
/;


binary variables
  x(iext,Lext,iext,Lext)  'arcs'
;

variables cost;

equations
  nodbal       'node balance'
  obj          'objective'
;


obj.. cost =e= sum(a,c(a)*x(a));

nodbal(iext,L1ext)..
  sum(a(jext,L2ext,iext,L1ext), x(a)) + pinflow(iext,L1ext) =e= sum(a(iext,L1ext,jext,L2ext), x(a));

model m /all/;
* this is pure network: we can solve as an LP
m.optfile=1;
solve m minimizing cost using rmip;
option x:2:2:2;
display cost.l, x.l;


*
* reporting
*
set xij(i,jext) 'items i..j to into same box';
xij(i,jext) = sum((L1ext,L2ext),x.l(i,L1ext,jext+1,L2ext)) > 0.5;

parameter results(*,*,*);
results(xij(i,j),'minsize') = size(i);
results(xij(i,j),'maxsize') = size(j);
results(xij(i,j),'area') = sqr(size(j));
results(xij(i,j),'count') = sum(ijk(i,j,k),count(k));
results(xij(i,j),'sum area') = sqr(size(j)) * sum(ijk(i,j,k),count(k));
results('total','','sum area') = cost.l;
results('total','','count') = sum(ijk(xij(i,j),k),count(k));
display results;



$onecho > cplex.opt
lpmethod 3
$offecho